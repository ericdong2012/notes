## jmeter

### 0. 基本概念

```
1. 性能测试，压力测试

压力测试：对系统不断施加压力的测试，是通过确定一个系统的瓶颈或者不能接收的性能点，来获得系统能提供的最大服务级别的测试。例如测试一个 Web 站点在大量的负荷下，何时系统的响应会退化或失败。

性能测试：在交替进行负荷和强迫测试时常用的术语。性能测试关注的是系统的整体。它和通常所说的强度、压力/负载测试测试有密切关系。所以压力和强度测试应该于性能测试一同进行。

压力测试是为了得到性能指数最小时候(可以接受的最小指数)最大的压力数
性能测试是为了得到压力数确定下的性能指数

举例说明：
	针对一个网站进行测试，模拟10到50个用户就是在进行常规性能测试，用户增加到1000乃至上万就变成了压力/负载测试。如果同时对系统进行大量的数据查询操作，就包含了强度测试。

	性能测试(Performance) 正常使用的时间内系统完成一个任务需要的时间,多人同时使用的时候响应时间,在可以接受范围内.J2EE技术实现的系统在性能方面更是需要照顾的,一般原则是3秒以下接受,3-5秒可以接受,5秒以上就影响易用性了. 如果在测试过程中发

2. jmeter 和 loadrunner 
相同点:
    1、原理都是通过中间代理，监控与收集并发客户端发现的指令，将他们生成脚本，并发送到应用服务器，再监控服务器反馈结果的一个过程
    2、分布式中间代理，可以设置代理在多台不同的PC中，通过远程控制使多台机器来分担自身的压力，借此达到能给获取更大的并发用户数
    3、录制功能，jmeter与loadrunner都具备的有录制脚本的功能，jmeter利用本地Proxy Server（代理服务器）来进行录制生成脚本，但是这个功能并不好用，录制完成后对象的个别参数需要手工添加，loadrunner自带通过代理方式录制脚本,无需安装其他插接件。
    
不同点：
1、jmeter安装简单快捷，只需要将安装包解压，然后配置好相对的环境变量即可使用，当然需要jdk环境的支持，loadrunner光安装包就1G多，在一般的PC上安装需要一个多小时时间，安装环境比较严谨，安装过程中可能会出现各种各样的问题报错，教旧的版本还好，网上能有写解决方法，安装新版本就另说啦，不管是哪个版本一旦出错，解决每一个问题都是比较花时间的，由于正版loadrunner收费的原因很多人在学习阶段会安装盗版，loadrunner比较坑的一点就是装过较旧的盗版不能再装新版

2、Jmeter中没有IP欺骗，但是可以通过其他方式实现，做些比较复杂的操作会比较麻烦。loadrunner中自带有的这一个功能，在平时简单测试时IP欺骗根本没什么用，但是在压力测试时，当某一个IP访问过于频繁或者访问量过大时，服务器会拒绝访问请求，这时候就需要用到IP欺骗来达到压力测试的效果。某些服务器配置了负载均衡，使用同一个IP测不出系统的实际，loadrunner可以通过IP欺骗调用不同的IP，很大程度上的模拟实际使用中的多个IP访问和并发测试服务器均衡处理的能力，还有些针对某些做了限制同一用户同一个IP的登录，loadrunner可以在模拟运行的用户中使用不同的IP

3、jmeter报表较少，对于分析性能不足以作为依据，如果要知道数据库服务器或者应用程序服务器的CPU，memory等参数的在相关的服务器上另外写脚本记录服务器性能。loadrunner的报表就想当的全，对分析性能不足时提供很多的依据

4、性能配置，jmeter在做性能配置时主要是通过增加线程组的数量，或者设置循环的次数来达到增加并发用户。而loadrunner可以通过Controller场景设置进行配置达到配置不同的性能测试需求

5、jmeter可以做web程序的功能测试，利用jmeter中的样本取样，可以做灰盒测试，当然loadrunner也是可以的，不过比jmeter麻烦很多，loadrunner主要用于作性能测试

6、jmeter为开源软件，网络上资料不是很全面，需要自己去揣摩，loadrunner是商业软件，如果是正版的话有技术支持的同时网络上还有很朵的资料

7、jmeter的脚本修改主要是对于jmeter中各个部件的熟悉程度，以及相关的协议掌握情况，不依赖与编程，而loadrunner除了复杂的场景外，还需要掌握函数，修改脚本基本上都是属于编程

安装简单，使用简单，但是没有Ip欺骗，报表较少，但是也够用了， 可用于ws, http 
```



### 1. 基本使用

```
# 基本认识

# 作用
web自动化
接口测试
性能测试
压力测试
使用jdbc进行数据库测试

# jdk安装
点击下载的jdk 可执行文件，安装
配置环境变量
	我的电脑---属性---高级设置---环境变量---新建JAVA_HOME="jdk路径"---点击path,
	添加JAVA_HOME, %JAVA_HOME%\bin
	
命令行测试
	java -version  
	javac -version
	
# jmeter安装及启动
已提供，直接解压，进到bin, 点击 jmeter.bat 或者 ApacheJMeter.jar


# jmeter.property
sampleresult.default.encoding=utf-8
```



### 2. 测试计划和线程组

```
# 基本概念
测试计划： 勾选(选中)第一个
    # 线程组：   一个用户就是一个线程组
        线程数  
        ramp_up：   几秒启动指定的线程数
        循环次数：   执行多少次

    # setup线程组：   最开始执行
    # teardown线程组: 最后执行
```



### 3. 测试片段

```
1. 跟线程组是同级别，
2. 不会直接运行，要运行，需要现在线程组中添加(逻辑控制器)模块控制器
3. 线程组中的先运行，测试片段后运行
```



### 4. 原件

```
# 八大元件及其作用域
// 先要选择线程组
取样器：    任何时候都会执行
逻辑控制器： 对子元件有绝对的控制权

其他6个，如果父类是取样器，只对父元件起作用，如果父类不是取样器，对所有子类起作用

# 执行顺序(从上往下)
配置元件(请求头，cookie等)
前置处理器(用户参数等)
定时器
取样器(http请求, jdbc request)
后置处理器(json提取器等)
断言(判断结果等)
监听器(结果展示，汇总等)
```



### 5. 参数化

```
1. csv
    # 概念
    动态的获取或设置数据(可以不同的用户不同的参数)

    # csv（逗号分隔值文件）
    name,age,hobby
    zhangsan,18,dotest

    # 添加csv文件
    线程组---添加配置元件---csv文件数据文件配置
    csv数据文件设置---文件名，文件编码，变量名称
    http请求---参数，添加，值($name等)
    修改线程组的线程数

    遇到文件结束符再次循环 true/false   false
    遇到文件结束符停止线程 true/false   true


2. 用户参数
    # 适用于参数较小的场景

    # 添加用户参数
    线程组---前置处理器---用户参数
    添加变量，添加用户
    http请求---参数，添加，值($name等)
    更改测试计划的线程数

    # 添加用户自定义参数
    线程组---配置元件---用户定义的变量
    添加(名称，值)
    http请求---参数，添加，值($name等)
    更改测试计划的线程数

    # 学生管理系统案例
    见资料 参数化学院系统.jmx  参数化学院删除.jmx

    删除：
        选项---函数生成助手
        先生成counter，再添加intsum
        ${__intSum(${__counter(false\,)},665,)}
        
```

### 6. 数据库

```
# 连接数据库，需要相应的驱动，并将其放到jmeter lib目录下

# 添加sqlite数据库
添加线程组---添加配置文件---添加jdbc connection configuration
更改配置文件名，最大连接数
database url:
	jdbc:sqlite:D:\\资料\\自动化测试\\4接口测试\\1-教学资料\\项目\\studentManagementSystem\\db.sqlite3

jdbc Driver class : 
	org.sqlite.jdbc
	
	
线程组---取样器---jdbc request
输入mysqlite
query type: update / select statement  （增删改查），并输入查询语句
添加查看结果树


# 添加mysql数据库
Database url: jdbc:mysql://127.0.0.1:3307/iwebshop
jdbc Driver class: com.mysql.jdbc.Driver
Username:root

# oracle数据库
Database url: jdbc:oracle:thin:@localhost:1521:orcl
jdbc Driver class: oracle.jdbc.OracleDriver
Username:xxx
Password:yyy
```

### 7. 关联

```
# 概念
一个请求需要用到另一个响应的结果

# 添加关联（见资料关联.jmx）
## 正则
## xpath  记得勾选use tidy
	用$$引用起来，如果在正则表达式中有多个正则表达式（多个括号括起来的东东），则可以是$2$$3$等等，表示解析到的第几个值给title。如：$1$表示解析到的第1个值
## json
```



### 8. 断言

```
#  几个基本概念
apply to：是应用范围，设定匹配的范围
    Main sample and sub-samples:匹配范围为当前父取样器，及子取样器
    Main sample only ：仅当前父取样器
    Sub samples only:仅子取样器
    JMeter Variable：变量值进行匹配

要测试的响应文字：针对响应数据不同部分进行匹配
    响应文本：响应服务器返回的文本内容，http协议排除header部分
    响应代码：匹配响应代码，比如http请求中'200'代表成功, 状态码
    响应信息：匹配响应信息，处理成功返回"Found"或者“OK”字样,区分大小写
    Response Header:匹配响应头中的信息  （包括/substring 200,ok)

匹配规则：
    包括：响应内容包括需要匹配的内容就算成功
    匹配：响应内容要完全匹配匹配内容，不区分大小写
    equals：完全相等，区分大小写
    substring：响应内容包括匹配内容即为成功。




# 响应断言    响应代码---equals---200/400/404  ; 响应文本---substring---百度一下
	注意事项： 响应文本 包括，匹配可以用正则，equals,substring 不支持正则(当做完整字符串)
# 大小断言   
	full response
	response headers
	response body

# 断言持续时间 断言成功的最大时间
```



### 9. 集合点

```
# 添加集合点
线程组---定时器---synchroning timer

number of simulated Users to Group By : 10 （集结10个再运行）
Timeout in milliseconds: 1000 （1s内集结完成）
```

### 10. 常用函数

```
counter  计数器
intsum   加法
csvRead  第一个参数: 文件路径，第二个参数：csv中的第几列， 编码存在问题，只支持ascii
Random   
time

setProperty 把指定数据设置成Jmeter属性(全局变量)
	线程组---取样器---bean shell取样器---脚本(函数助手)
Property    获取上面设置的全局变量(脚本(函数助手))
	
```


### 11. 分布式

基本概念

```
# 现状
按照一般的压力机配置，jmeter的GUI模式下（Windows），最多支持300左右的模拟请求线程**，再大的话，容易造成卡顿、无响应等情况，这是限于jmeter其本身的机制和硬件配置。

有时候为了尽量模拟业务场景，需要模拟大量的并发请求，这个时候单台压力机就显得有心无力。针对这个情况，jmeter的解决方案是支持分布式压测，即将大量的模拟并发分配给多台压力机，来满足这种大流量的并发请求场景。


# 解决办法
分布式

# 分布式执行原理
1. 一台电脑作为控制机(Controller)，其它电脑做为执行机(Agent);
2. 执行时，控制机会把脚本发送到每台执行机上，执行机拿到脚本后就开始执行
3. 执行机执行时不需要启动Jmeter界面，可以理解它是通过命令行模式执行的
4. 执行完成后，执行机会把结果回传给控制机，控制机会收集所有执行机的信息并汇总

```



操作步骤

1.执行机Jmeter.properties配置

```
1. 分别打开执行机下jmeter安装文件下的bin目录:jmeter.properties, 找到server_port
2. server_Port=1099.    1099为执行机自定义端口号(另一台配置为1100)
3. 注意:
    - 要取消注释符号 #
    - 自定义的端口号,要选择未被占用的端口号
```



2.控制机jmeter.properties配置

```
1.打开控制机下jmeter安装文件下的bin目录:jmeter.properties,找搭配remote_hosts
2. remote_hosts=127.0.0.1:1099,127.0.0.1:1100
3. 注意事项:
   - 多个执行机的ip间要用全英文的半角逗号隔开
```



3.执行机启动分布式

```
1. 分别运行bin目录下jmeter-server.bat
2. 运行后勿关闭黑色窗口
```



4.控制机-线程数设置

```
线程组---取样器---http请求 
需求1000用户,两台执行机同时接受控制机脚本去执行然后反馈给控制机，所以(线程组)线程数设置500
```



5.控制机运行

```
点击菜单栏---运行---远程启动全部
```



注意事项：

```
1. 修改完端口要重启Jmeter.bat
2. 控制机和执行机分开(为了方便教学,这里采用控制机和代理机在1台机器上)
   1). 由于控制机需要发送信息给执行机并且会接受执行机回传的测试数据所以控制机自身会有消耗
3. 参数文件：如果使用csv进行参数化，那么需要把参数文件在每台执行机上拷一份且路径需要设置成一样的；
4. 每台机器上安装的Jmeter版本和插件最好都一致，否则会出一些意外的问题；
5. 执行机上Jmeter也许需要配置JDK环境变量；
```





### 12. 逻辑控制器

#### 2.1 if控制器

```
# 作用
条件成真,则执行控制器下所有取样器

# 操作
1. 测试计划->线程组
1. 测试计划->用户自定义变量
2. 线程组->如果（If）控制器
3. 如果（If）控制器->HTTP请求
4. 测试计划-察看结果树


# 注意点
1. 条件:"${name}"=="百度"
2. 注意：
    1) 引用变量格式${name}需要被双引号括起来
    2) 两个等号
    3) 值需要被双引号括起来
```



#### 2.2 ForEach控制器

```
# 作用
ForEach控制器一般和用户定义的变量一起使用，在用户自定义变量中读取一系列相关的变量。

# 操作
1. 测试计划->线程组
2. 线程组->用户定义的变量
3. 线程组->ForEach控制器
4. ForEach控制器->HTTP请求
5. 测试计划->察看结果树

# 注意点
1. 输入前缀变量：输入要遍历变量前缀(name)
2. 开始循环字段(不包含):遍历变量开始的索引    0(从1开始)   
3. 结束循环字段(包含):遍历变量结束的索引      3
4. 输出变量名称:定义要被引用的变量名称    name(该name用于在http请求中的值)
```



#### 2.3 交替控制器

```
# 作用：交替控制，该控制器包含的所有取样器，步骤交错执行在每个循环

# 操作
1. 测试计划->线程组
2. 线程组->HTTP请求(查询学院-所有)
3. 线程组->交替控制器
4. 交替控制器->HTTP请求(查询学院-指定)
5. 交替控制器->HTTP请求(查询学院-id_list)


注意线程组的设置 循环次数
```



#### 2.4 循环控制器

```
# 作用：指定循环控制器内取样器的执行次数

# 操作
1. 测试计划->线程组
2. 线程组->循环控制器
3. 循环控制器->HTTP请求(查询学院-所有)
4. 测试计划->察看结果树

```

#### 2.5 仅一次控制器

```
# 如果线程组 循环次数开启了10， 则只运行一次
```



#### 2.6随机控制器和随机顺序控制器

```
# 随机控制器： 从几个请求中随机选择一个
# 随机顺序控制器： 将几个请求都执行，但是顺序随机
```



#### 2.7 while控制器

```
# 注意事项
1. 为空：最后一个请求失败，停止循环；(如果不是最后一个请求执行失败，则继续循环)
2. LAST：
    1) 与为空相同之处：最后一个请求失败，停止循环；(如果不是最后一个请求执行失败，则继续循环)
    2) 与为空不同之处：测试计划在执行while控制器之前如果有请求失败，则不会执行while控制器
3. 表达式：表达式为false退出循环；
    例如：
        1) ${VAR}:当参数VAR的值被设置成false时退出循环
        2) ${__javascript(“${VAR}”==”User1”)}:当参数VAR的值部位User1时退出循环
```



#### 2.8 switch控制器

```
# 作用：通过给该控制器中的value赋值，来指定运行哪个取样器;
# 注意事项
1. Switch Value：为采样器名称；执行采样器名称相应的请求
2. Switch Value：为空；默认为执行第一个
3. Switch Value：为索引；第一个为0

```

#### 2.9 简单控制器

```
# 作用：只做分组使用，犹如打隔断；
```



#### 2.10 事务控制器

```
# 作用：生成一个额外的采样器来测量其下测试元素的总体时间； 
       值得注意的是，这个时间包含该控制器范围内的所有处理时间，而不仅仅是采样器的
       如果事务控制器下的某一个请求失败，可改事务失败
       
       如果勾选了事务控制器中的选项， 则结果展示会以树形结果进行展示
      
```



### 13. 功能脚本设计

见 资料代码---学院功能脚本

```
# http 请求默认值  get  127.0.0.1  8000 utf-8
# http 信息头管理器    Content-Type

# 查询
# 新增
# 更新
# 删除(单个，列表)
```



### 14. 接口测试用例及参数设计 

> 上面功能脚本设计只是正常的参数设计，还没有特殊情况的考虑，故有了下面正向，逆向参数设计等



见课件

```
# 测试用例设计原则
1. 覆盖所有的必选参数
2. 组合可选参数
3. 参数边界值
4. 如果参数的取值范围是枚举变量，需要覆盖所有枚举值    
5. 空数据
6. 包含特殊的字符
7. 越界的数据
8. 错误的数据


# 用例格式
用例编号	用例名称	方法	测试步骤	预期结果	是否通过	备注

# 测试数据
## 正向方法
1. 传入所有可传属性，且格式正确
2. 传入必填属性，且格式正确

## 校验方法
1) 为空校验
2) 为空格校验
3) 前后含空格校验
4) 超长校验
5) 类型校验
6) 含特殊字符校验
7) 删除引用校验
8) 唯一不重复属性校验

例子：学院-组合查询参数化示例

Here is Slogan,Test-Master,Test学院,----正向数据
,Test-Master,Test学院,----两个条件组合
,,Test学院,----单个条件
Here is Slogan,,,----正向数据
,Test-Master,,----正向数据
 Here is Slogan ,Test-Master,Test学院,----Here is Slogan前后含空格
Here is Slogan, Test-Master ,Test学院,----Test-Master前后含空格
Here is Slogan,Test-Master, Test学院 ,----Test学院前后含空格
 ,Test-Master,Test学院,----为空格
Here is Slogan, ,Test学院,----为空格
Here is Slogan,Test-Master, ,----为空格
Here is Slogan222,Test-Master,Test学院,----一个条件不存在
Here is Slogan,Test-Master22222222222222222222222222222,Test学院,----超长
Here is Slogan,Test-Master,Test%%%%%%%%%%%%%院,----含特殊字符
,,,----全部为空


```



### 15. 自动化测试设计

```
# 为什么要设计自动化脚本？
后台程序更新/发布新版之前需要验证下之前的功能是否能用

# 分析
1. 使用数据库连接池
2. 使用setUp Thread Group线程组
3. 使用tearDown Thread Group线程组
4. 使用线程组
5. 使用函数
6. 使用关联
7. 添加断言
8. 使用sampler中请求
9. 添加聚合报告

# 新增，删除
使用数据库配置信息， jdbc信息 ，添加响应断言

# 查询
# 更新
```



### 16. 性能脚本设计

```
# 聚合报告
# 汇总报告

聚合报告说明：
1. Label:在不勾选"Include group name in label?"复选框的情况下，为请求取样器的名称，
    否则为“请求取样器所在线程组:请求取样器名称”
2. Samples:用同一个请求取样器，发送请求的数量(注意：该值是不断累计的)。
    比如，10个线程数设置为10，迭代10次，那么每运行一次测试，该值就增加10*10=100
3. Average:请求的平均响应时间
4. Median:中位数。50%的样本都没有超过这个时间。
    这个值是指把所有数据按由小到大将其排列，就是排列在第50%的值。
5. 90% Line：90%的样本都没有超过这个时间。这个值是指把所有数据按由小到大将其排列，就是排列在第90%的值。
6. Min:针对同一请求取样器，请求样本的最小响应时间
7. Max:针对同一请求取样器，请求样本的最大响应时间
8. Error %:出现错误的请求样本的百分比
9. Throughput：吞吐量以“requests/second、requests /minute、requests /hour”来衡量。
    时间单位已经被选取为second，所以，显示速率至少是1.0，即每秒1个请求。
10. Received KB/sec - 收到的千字节每秒的吞吐量测试。
11. Kb/sec - 以Kilobytes/seond来衡量的吞吐量(发送的千字节每秒的吞吐量测试)
```



### 17. 生成文档

```
# 无日志文件生成
jmeter -n -t <test JMX file> -l <test log file> -e -o <Path to output folder>

参数详解：
-n ：以非GUI形式运行Jmeter

-t ：source.jmx 脚本路径

-l ：运行结果保存路径（.jtl）,此文件

必须不存在

  1) .jtl
  2) .txt
  3) 无后缀
-e ：在脚本运行结束后生成html报告

-o ：保存html报告的地址, 此文件必须不存在



例子：jmeter -n -t E:\课件\Jmeter\Script\自动化脚本\Stu_AutoScript.jmx -l E:\课件\Jmeter\Script\自动化脚本\testLog -e -o E:\课件\Jmeter\Script\自动化脚本\report

最终文件目录效果：
	自动化脚本
		Stu_AutoScript.jmx
		testlog
		report
			xx
			xx
			xx
		


# 使用已有的jtl日志文件或csv日志文件生成
jmeter -g <log file> -o <Path to output folder>

例子：jmeter -g E:\课件\Jmeter\Script\自动化脚本\resultt.jtl -o ./outputreport
```



